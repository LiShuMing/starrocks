-- name: test_sync_materialized_view2

-- CASE1
drop table if exists test2;
CREATE TABLE `test2` (
  `k1` tinyint(4) NULL DEFAULT "0",
  `k2` varchar(64) NULL DEFAULT "",
  `k3` bigint NULL DEFAULT "0",
  `k4` varchar(64) NULL DEFAULT ""
) ENGINE=OLAP 
DUPLICATE KEY(`k1`)
DISTRIBUTED BY HASH(`k1`) BUCKETS 1
PROPERTIES (
"replication_num" = "1"
);

drop table if exists target2;
CREATE TABLE `target2` (
  `k1` tinyint(4) NULL DEFAULT "0",
  `k2` int NULL DEFAULT "0",
  `k11` tinyint(4) NULL DEFAULT "0",
  `k4` bigint sum DEFAULT "0",
  `k5` hll hll_union
) ENGINE=OLAP 
AGGREGATE KEY(`k1`, `k2`, `k11`)
DISTRIBUTED BY HASH(`k1`) BUCKETS 1
PROPERTIES (
"replication_num" = "1"
);

CREATE MATERIALIZED VIEW test_mv2 
PROPERTIES ( "enable_populate" = "false" ) 
to target2
as
-- select k1 * 2 as k1, length(k2) as k2, sum(k3) as k4, hll_union(hll_hash(k4)) as k5 from test2 group by k1, k2; 
select k1, length(k2) as k2, cast(k1 * 2 as tinyint(4)) as k11,  sum(k3) as k4, hll_union(hll_hash(k4)) as k5 from test2 group by k1, k2; 

insert into test2 values (1, 'a', 1, 'aa'), (2, 'b', 1, 'aa'), (3, 'a', 1, 'cc');
select * from test2 order by k1;
select * from target2 order by k1;
drop materialized view test_mv2;

--- CASE2
CREATE TABLE `test3` (
  `k1` tinyint(4) NULL DEFAULT "0",
  `k2` varchar(64) NULL DEFAULT "",
  `k3` bigint NULL DEFAULT "0",
  `k4` varchar(64) NULL DEFAULT ""
) ENGINE=OLAP 
DUPLICATE KEY(`k1`)
DISTRIBUTED BY HASH(`k1`) BUCKETS 1
PROPERTIES (
"replication_num" = "1"
);

CREATE TABLE `target3` (
  `k1` tinyint(4) NULL DEFAULT "0",
  -- `k2` varchar(64) NULL DEFAULT "0",
  `k2` int NULL DEFAULT "0",
  `k11` tinyint(4) NULL DEFAULT "0",
  `k4` bigint sum DEFAULT "0",
  `k5` hll hll_union
) ENGINE=OLAP 
AGGREGATE KEY(`k1`, `k2`, `k11`)
DISTRIBUTED BY HASH(`k1`) BUCKETS 1
PROPERTIES (
"replication_num" = "1"
);

CREATE MATERIALIZED VIEW test_mv3 
PROPERTIES ( "enable_populate" = "false" ) 
to target3
as
select k1, length(k2) as k2, cast(k1 * 2 as tinyint(4)) as k11, sum(k3), hll_union(hll_hash(k4)) as k5 from test3 group by k1, k2; 

insert into test3 values (1, 'a', 1, 'aa'), (2, 'b', 1, 'aa'), (3, 'a', 1, 'cc');
select * from test3 order by k1;
select * from target3 order by k1;

CREATE MATERIALIZED VIEW test_mv3_1
PROPERTIES ( "enable_populate" = "false" ) 
to target3
as
select k1, length(k2) as k2, k1 * 2 as k11, sum(k3), hll_union(hll_hash(k4)) as k5 from test2 group by k1, k2; 
insert into test2 values (1, 'a', 1, 'aa'), (2, 'b', 1, 'aa'), (3, 'a', 1, 'cc');
select * from test3 order by k1;
select * from target3 order by k1;

CREATE TABLE `test8` (
  `k1` tinyint(4) NULL DEFAULT "0",
  `k2` varchar(64) NULL DEFAULT "",
  `k3` bigint NULL DEFAULT "0",
  `k4` varchar(64) NULL DEFAULT ""
) ENGINE=OLAP 
DUPLICATE KEY(`k1`)
DISTRIBUTED BY HASH(`k1`) BUCKETS 1
PROPERTIES (
"replication_num" = "1"
);
CREATE TABLE `target8` (
  `k1` tinyint(4) NULL DEFAULT "0",
  `k22` int NULL DEFAULT "0",
  `k33` bigint sum DEFAULT "0",
  `k44` hll hll_union
) ENGINE=OLAP 
AGGREGATE KEY(`k1`, `k22`)
DISTRIBUTED BY HASH(`k1`) BUCKETS 1
PROPERTIES (
"replication_num" = "1"
);
CREATE MATERIALIZED VIEW test_mv8 
PROPERTIES ( "enable_populate" = "false" ) 
to target8
as
select k1, length(k2) as k22, sum(k3) as k33, hll_union(hll_hash(k4)) as k44 from test8 group by k1, k22; 
insert into test8 values (1, 'a', 1, 'aa'), (2, 'b', 1, 'aa'), (3, 'a', 1, 'cc');
select * from test8 order by k1;
select * from target8 order by k1;
