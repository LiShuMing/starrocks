-- name: test_sync_materialized_view_count_distinct

CREATE TABLE user_event (
    ds date   NOT NULL,
    id  varchar(256)    NOT NULL,
    user_id int DEFAULT NULL,
    user_id1    varchar(256)    DEFAULT NULL,
    user_id2    varchar(256)    DEFAULT NULL,
    column_01   int DEFAULT NULL,
    column_02   int DEFAULT NULL,
    column_03   int DEFAULT NULL,
    column_04   int DEFAULT NULL,
    column_05   int DEFAULT NULL,
    column_06   DECIMAL(12,2)   DEFAULT NULL,
    column_07   DECIMAL(12,3)   DEFAULT NULL,
    column_08   JSON   DEFAULT NULL,
    column_09   DATETIME    DEFAULT NULL,
    column_10   DATETIME    DEFAULT NULL,
    column_11   DATE    DEFAULT NULL,
    column_12   varchar(256)    DEFAULT NULL,
    column_13   varchar(256)    DEFAULT NULL,
    column_14   varchar(256)    DEFAULT NULL,
    column_15   varchar(256)    DEFAULT NULL,
    column_16   varchar(256)    DEFAULT NULL,
    column_17   varchar(256)    DEFAULT NULL,
    column_18   varchar(256)    DEFAULT NULL,
    column_19   varchar(256)    DEFAULT NULL,
    column_20   varchar(256)    DEFAULT NULL,
    column_21   varchar(256)    DEFAULT NULL,
    column_22   varchar(256)    DEFAULT NULL,
    column_23   varchar(256)    DEFAULT NULL,
    column_24   varchar(256)    DEFAULT NULL,
    column_25   varchar(256)    DEFAULT NULL,
    column_26   varchar(256)    DEFAULT NULL,
    column_27   varchar(256)    DEFAULT NULL,
    column_28   varchar(256)    DEFAULT NULL,
    column_29   varchar(256)    DEFAULT NULL,
    column_30   varchar(256)    DEFAULT NULL,
    column_31   varchar(256)    DEFAULT NULL,
    column_32   varchar(256)    DEFAULT NULL,
    column_33   varchar(256)    DEFAULT NULL,
    column_34   varchar(256)    DEFAULT NULL,
    column_35   varchar(256)    DEFAULT NULL,
    column_36   varchar(256)    DEFAULT NULL,
    column_37   varchar(256)    DEFAULT NULL,
    column_38   varchar(256)    DEFAULT NULL,
    column_39   varchar(256)    DEFAULT NULL,
    column_40   varchar(256)    DEFAULT NULL,
    column_41   varchar(256)    DEFAULT NULL,
    column_42   varchar(256)    DEFAULT NULL,
    column_43   varchar(256)    DEFAULT NULL,
    column_44   varchar(256)    DEFAULT NULL,
    column_45   varchar(256)    DEFAULT NULL,
    column_46   varchar(256)    DEFAULT NULL,
    column_47   varchar(256)    DEFAULT NULL,
    column_48   varchar(256)    DEFAULT NULL,
    column_49   varchar(256)    DEFAULT NULL,
    column_50   varchar(256)    DEFAULT NULL,
    column_51   varchar(256)    DEFAULT NULL,
    column_52   varchar(256)    DEFAULT NULL,
    column_53   varchar(256)    DEFAULT NULL,
    column_54   varchar(256)    DEFAULT NULL,
    column_55   varchar(256)    DEFAULT NULL,
    column_56   varchar(256)    DEFAULT NULL,
    column_57   varchar(256)    DEFAULT NULL,
    column_58   varchar(256)    DEFAULT NULL,
    column_59   varchar(256)    DEFAULT NULL,
    column_60   varchar(256)    DEFAULT NULL,
    column_61   varchar(256)    DEFAULT NULL,
    column_62   varchar(256)    DEFAULT NULL,
    column_63   varchar(256)    DEFAULT NULL,
    column_64   varchar(256)    DEFAULT NULL,
    column_65   varchar(256)    DEFAULT NULL,
    column_66   varchar(256)    DEFAULT NULL,
    column_67   varchar(256)    DEFAULT NULL,
    column_68   varchar(256)    DEFAULT NULL,
    column_69   varchar(256)    DEFAULT NULL,
    column_70   varchar(256)    DEFAULT NULL,
    column_71   varchar(256)    DEFAULT NULL,
    column_72   varchar(256)    DEFAULT NULL,
    column_73   varchar(256)    DEFAULT NULL,
    column_74   varchar(256)    DEFAULT NULL,
    column_75   varchar(256)    DEFAULT NULL,
    column_76   varchar(256)    DEFAULT NULL,
    column_77   varchar(256)    DEFAULT NULL,
    column_78   varchar(256)    DEFAULT NULL,
    column_79   varchar(256)    DEFAULT NULL,
    column_80   varchar(256)    DEFAULT NULL,
    column_81   varchar(256)    DEFAULT NULL,
    column_82   varchar(256)    DEFAULT NULL,
    column_83   varchar(256)    DEFAULT NULL,
    column_84   varchar(256)    DEFAULT NULL,
    column_85   varchar(256)    DEFAULT NULL,
    column_86   varchar(256)    DEFAULT NULL,
    column_87   varchar(256)    DEFAULT NULL,
    column_88   varchar(256)    DEFAULT NULL,
    column_89   varchar(256)    DEFAULT NULL,
    column_90   varchar(256)    DEFAULT NULL,
    column_91   varchar(256)    DEFAULT NULL,
    column_92   varchar(256)    DEFAULT NULL,
    column_93   varchar(256)    DEFAULT NULL,
    column_94   varchar(256)    DEFAULT NULL,
    column_95   varchar(256)    DEFAULT NULL,
    column_96   varchar(256)    DEFAULT NULL,
    column_97   varchar(256)    DEFAULT NULL,
    column_98   varchar(256)    DEFAULT NULL

)
partition by date_trunc("day", ds)
distributed by hash(id);
 

INSERT INTO user_event (ds, id, user_id, user_id1, user_id2, column_01, column_02, column_03, column_04, column_05, column_06, column_07, column_08, column_09, column_10, column_11, column_12, column_13, column_14, column_15, column_16, column_17, column_18, column_19, column_20, column_21, column_22, column_23, column_24, column_25, column_26, column_27, column_28, column_29, column_30, column_31, column_32, column_33, column_34, column_35, column_36, column_37, column_38, column_39, column_40, column_41, column_42, column_43, column_44, column_45, column_46, column_47, column_48, column_49, column_50, column_51, column_52, column_53, column_54, column_55, column_56, column_57, column_58, column_59, column_60, column_61, column_62, column_63, column_64, column_65, column_66, column_67, column_68, column_69, column_70, column_71, column_72, column_73, column_74, column_75, column_76, column_77, column_78, column_79, column_80, column_81, column_82, column_83, column_84, column_85, column_86, column_87, column_88, column_89, column_90, column_91, column_92, column_93, column_94, column_95, column_96, column_97, column_98)
VALUES
('2023-11-02', '1', 1, '2', '1', 10, 20, 30, 40, 50, 12.34, 56.789, '{"key":""}', '2023-11-02 12:34:56', '2023-11-02 12:34:56', '2023-11-02', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98'),
('2023-11-02', '1', 1, '2', '1', 10, 20, 30, 40, 50, 12.34, 56.789, '{"key":""}', '2023-11-02 12:34:56', '2023-11-02 12:34:56', '2023-11-02', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98');

------- CASE1 : NO WHERE
create materialized view test_mv1
as 
select
ds
,column_19 
,column_36
,sum(column_01) as column_01_sum
,bitmap_union(to_bitmap( user_id)) as user_id_dist_cnt
,bitmap_union(to_bitmap(case when column_01 > 1 and column_34 IN ('1','34')   then user_id2 else null end)) as filter_dist_cnt_1
,bitmap_union(to_bitmap( case when column_02 > 60 and column_35 IN ('11','13') then  user_id2 else null end)) as filter_dist_cnt_2
,bitmap_union(to_bitmap(case when column_03 > 70 and column_36 IN ('21','23') then  user_id2 else null end)) as filter_dist_cnt_3
,bitmap_union(to_bitmap(case when column_04 > 20 and column_27 IN ('31','27') then  user_id2 else null end)) as filter_dist_cnt_4
,bitmap_union(to_bitmap( case when column_05 > 90 and column_28 IN ('41','43') then  user_id2 else null end)) as filter_dist_cnt_5
 from user_event
 group by
 ds
 ,column_19
 ,column_36;

function: wait_materialized_view_finish()

result=explain select
ds
,column_19 
,column_36
,sum(column_01) as column_01_sum
,bitmap_union_count(to_bitmap( user_id)) as user_id_dist_cnt
,bitmap_union_count(to_bitmap(case when column_01 > 1 and column_34 IN ('1','34')   then user_id2 else null end)) as filter_dist_cnt_1
,bitmap_union_count(to_bitmap( case when column_02 > 60 and column_35 IN ('11','13') then  user_id2 else null end)) as filter_dist_cnt_2
,bitmap_union_count(to_bitmap(case when column_03 > 70 and column_36 IN ('21','23') then  user_id2 else null end)) as filter_dist_cnt_3
,bitmap_union_count(to_bitmap(case when column_04 > 20 and column_27 IN ('31','27') then  user_id2 else null end)) as filter_dist_cnt_4
,bitmap_union_count(to_bitmap( case when column_05 > 90 and column_28 IN ('41','43') then  user_id2 else null end)) as filter_dist_cnt_5
 from user_event
 group by
 ds
 ,column_19
 ,column_36
 order by 
 ds
 ,column_19
 ,column_36;

function: check_hit_materialized_view_plan("""${result}""", "test_mv1")

function: check_hit_materialized_view("select ds,column_19 ,column_36,sum(column_01) as column_01_sum,count(distinct  user_id) as user_id_dist_cnt,count(distinct (case when column_01 > 1 and column_34 IN ('1','34')   then user_id2 else null end)) as filter_dist_cnt_1,count(distinct ( case when column_02 > 60 and column_35 IN ('11','13') then  user_id2 else null end)) as filter_dist_cnt_2,count(distinct (case when column_03 > 70 and column_36 IN ('21','23') then  user_id2 else null end)) as filter_dist_cnt_3,count(distinct (case when column_04 > 20 and column_27 IN ('31','27') then  user_id2 else null end)) as filter_dist_cnt_4,count(distinct ( case when column_05 > 90 and column_28 IN ('41','43') then  user_id2 else null end)) as filter_dist_cnt_5 from user_event group by ds,column_19,column_36", "test_mv1")

select
ds
,column_19 
,column_36
,sum(column_01) as column_01_sum
,bitmap_union_count(to_bitmap( user_id)) as user_id_dist_cnt
,bitmap_union_count(to_bitmap(case when column_01 > 1 and column_34 IN ('1','34')   then user_id2 else null end)) as filter_dist_cnt_1
,bitmap_union_count(to_bitmap( case when column_02 > 60 and column_35 IN ('11','13') then  user_id2 else null end)) as filter_dist_cnt_2
,bitmap_union_count(to_bitmap(case when column_03 > 70 and column_36 IN ('21','23') then  user_id2 else null end)) as filter_dist_cnt_3
,bitmap_union_count(to_bitmap(case when column_04 > 20 and column_27 IN ('31','27') then  user_id2 else null end)) as filter_dist_cnt_4
,bitmap_union_count(to_bitmap( case when column_05 > 90 and column_28 IN ('41','43') then  user_id2 else null end)) as filter_dist_cnt_5
 from user_event
 group by
 ds
 ,column_19
 ,column_36
 order by 
 ds
 ,column_19
 ,column_36;

select
ds
,column_19 
,column_36
,sum(column_01) as column_01_sum
 ,count(distinct  user_id) as user_id_dist_cnt
 ,count(distinct (case when column_01 > 1 and column_34 IN ('1','34')   then user_id2 else null end)) as filter_dist_cnt_1
 ,count(distinct ( case when column_02 > 60 and column_35 IN ('11','13') then  user_id2 else null end)) as filter_dist_cnt_2
 ,count(distinct (case when column_03 > 70 and column_36 IN ('21','23') then  user_id2 else null end)) as filter_dist_cnt_3
 ,count(distinct (case when column_04 > 20 and column_27 IN ('31','27') then  user_id2 else null end)) as filter_dist_cnt_4
 ,count(distinct ( case when column_05 > 90 and column_28 IN ('41','43') then  user_id2 else null end)) as filter_dist_cnt_5
 from user_event
 group by
 ds
 ,column_19
 ,column_36
  order by 
 ds
 ,column_19
 ,column_36;

 select
 column_19 
,column_36
 ,sum(column_01) as column_01_sum
 ,count(distinct user_id) as user_id_dist_cnt
,count(distinct (case when column_01 > 1 and column_34 IN ('1','34')  then user_id2 else null end)) as filter_dist_cnt_1
,count(distinct (case when column_02 > 60 and column_35 IN ('11','13') then  user_id2 else null end)) as filter_dist_cnt_2
 from user_event
 where ds in ('2023-11-02')
 group by
 ds
 ,column_19
 ,column_36
  order by 
 ds
 ,column_19
 ,column_36;

INSERT INTO user_event (ds, id, user_id, user_id1, user_id2, column_01, column_02, column_03, column_04, column_05, column_06, column_07, column_08, column_09, column_10, column_11, column_12, column_13, column_14, column_15, column_16, column_17, column_18, column_19, column_20, column_21, column_22, column_23, column_24, column_25, column_26, column_27, column_28, column_29, column_30, column_31, column_32, column_33, column_34, column_35, column_36, column_37, column_38, column_39, column_40, column_41, column_42, column_43, column_44, column_45, column_46, column_47, column_48, column_49, column_50, column_51, column_52, column_53, column_54, column_55, column_56, column_57, column_58, column_59, column_60, column_61, column_62, column_63, column_64, column_65, column_66, column_67, column_68, column_69, column_70, column_71, column_72, column_73, column_74, column_75, column_76, column_77, column_78, column_79, column_80, column_81, column_82, column_83, column_84, column_85, column_86, column_87, column_88, column_89, column_90, column_91, column_92, column_93, column_94, column_95, column_96, column_97, column_98)
VALUES
('2023-11-02', '1', 1, '2', '1', 10, 20, 30, 40, 50, 12.34, 56.789, '{"key":""}', '2023-11-02 12:34:56', '2023-11-02 12:34:56', '2023-11-02', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98'),
('2023-11-01', '1', 1, '2', '1', 10, 20, 30, 40, 50, 12.34, 56.789, '{"key":""}', '2023-11-02 12:34:56', '2023-11-02 12:34:56', '2023-11-02', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98');

function: check_hit_materialized_view("select ds,column_19 ,column_36,sum(column_01) as column_01_sum,count(distinct  user_id) as user_id_dist_cnt,count(distinct (case when column_01 > 1 and column_34 IN ('1','34')   then user_id2 else null end)) as filter_dist_cnt_1,count(distinct ( case when column_02 > 60 and column_35 IN ('11','13') then  user_id2 else null end)) as filter_dist_cnt_2,count(distinct (case when column_03 > 70 and column_36 IN ('21','23') then  user_id2 else null end)) as filter_dist_cnt_3,count(distinct (case when column_04 > 20 and column_27 IN ('31','27') then  user_id2 else null end)) as filter_dist_cnt_4,count(distinct ( case when column_05 > 90 and column_28 IN ('41','43') then  user_id2 else null end)) as filter_dist_cnt_5 from user_event group by ds,column_19,column_36", "test_mv1")

select
ds
,column_19 
,column_36
,sum(column_01) as column_01_sum
,bitmap_union_count(to_bitmap( user_id)) as user_id_dist_cnt
,bitmap_union_count(to_bitmap(case when column_01 > 1 and column_34 IN ('1','34')   then user_id2 else null end)) as filter_dist_cnt_1
,bitmap_union_count(to_bitmap( case when column_02 > 60 and column_35 IN ('11','13') then  user_id2 else null end)) as filter_dist_cnt_2
,bitmap_union_count(to_bitmap(case when column_03 > 70 and column_36 IN ('21','23') then  user_id2 else null end)) as filter_dist_cnt_3
,bitmap_union_count(to_bitmap(case when column_04 > 20 and column_27 IN ('31','27') then  user_id2 else null end)) as filter_dist_cnt_4
,bitmap_union_count(to_bitmap( case when column_05 > 90 and column_28 IN ('41','43') then  user_id2 else null end)) as filter_dist_cnt_5
 from user_event
 group by
 ds
 ,column_19
 ,column_36
 order by 
 ds
 ,column_19
 ,column_36;

select
ds
,column_19 
,column_36
,sum(column_01) as column_01_sum
 ,count(distinct  user_id) as user_id_dist_cnt
 ,count(distinct (case when column_01 > 1 and column_34 IN ('1','34')   then user_id2 else null end)) as filter_dist_cnt_1
 ,count(distinct ( case when column_02 > 60 and column_35 IN ('11','13') then  user_id2 else null end)) as filter_dist_cnt_2
 ,count(distinct (case when column_03 > 70 and column_36 IN ('21','23') then  user_id2 else null end)) as filter_dist_cnt_3
 ,count(distinct (case when column_04 > 20 and column_27 IN ('31','27') then  user_id2 else null end)) as filter_dist_cnt_4
 ,count(distinct ( case when column_05 > 90 and column_28 IN ('41','43') then  user_id2 else null end)) as filter_dist_cnt_5
 from user_event
 group by
 ds
 ,column_19
 ,column_36
  order by 
 ds
 ,column_19
 ,column_36;

 select
 column_19 
,column_36
 ,sum(column_01) as column_01_sum
 ,count(distinct user_id) as user_id_dist_cnt
,count(distinct (case when column_01 > 1 and column_34 IN ('1','34')  then user_id2 else null end)) as filter_dist_cnt_1
,count(distinct (case when column_02 > 60 and column_35 IN ('11','13') then  user_id2 else null end)) as filter_dist_cnt_2
 from user_event
 where ds in ('2023-11-02')
 group by
 ds
 ,column_19
 ,column_36
  order by 
 ds
 ,column_19
 ,column_36;

drop materialized view test_mv1;

------- CASE2 : WITH WHERE
create materialized view test_mv1
as 
select
ds
,column_19 
,column_36
,sum(column_01) as column_01_sum
,bitmap_union(to_bitmap( user_id)) as user_id_dist_cnt
,bitmap_union(to_bitmap(case when column_01 > 1 and column_34 IN ('1','34')   then user_id2 else null end)) as filter_dist_cnt_1
,bitmap_union(to_bitmap( case when column_02 > 60 and column_35 IN ('11','13') then  user_id2 else null end)) as filter_dist_cnt_2
,bitmap_union(to_bitmap(case when column_03 > 70 and column_36 IN ('21','23') then  user_id2 else null end)) as filter_dist_cnt_3
,bitmap_union(to_bitmap(case when column_04 > 20 and column_27 IN ('31','27') then  user_id2 else null end)) as filter_dist_cnt_4
,bitmap_union(to_bitmap( case when column_05 > 90 and column_28 IN ('41','43') then  user_id2 else null end)) as filter_dist_cnt_5
 from user_event
 where ds >= '2023-11-02'
 group by
 ds
 ,column_19
 ,column_36;

function: wait_materialized_view_finish()

function: check_no_hit_materialized_view("select ds,column_19 ,column_36,sum(column_01) as column_01_sum,count(distinct  user_id) as user_id_dist_cnt,count(distinct (case when column_01 > 1 and column_34 IN ('1','34')   then user_id2 else null end)) as filter_dist_cnt_1,count(distinct ( case when column_02 > 60 and column_35 IN ('11','13') then  user_id2 else null end)) as filter_dist_cnt_2,count(distinct (case when column_03 > 70 and column_36 IN ('21','23') then  user_id2 else null end)) as filter_dist_cnt_3,count(distinct (case when column_04 > 20 and column_27 IN ('31','27') then  user_id2 else null end)) as filter_dist_cnt_4,count(distinct ( case when column_05 > 90 and column_28 IN ('41','43') then  user_id2 else null end)) as filter_dist_cnt_5 from user_event group by ds,column_19,column_36", "test_mv1")
function: check_hit_materialized_view("select ds,column_19 ,column_36,sum(column_01) as column_01_sum,count(distinct  user_id) as user_id_dist_cnt,count(distinct (case when column_01 > 1 and column_34 IN ('1','34')   then user_id2 else null end)) as filter_dist_cnt_1,count(distinct ( case when column_02 > 60 and column_35 IN ('11','13') then  user_id2 else null end)) as filter_dist_cnt_2,count(distinct (case when column_03 > 70 and column_36 IN ('21','23') then  user_id2 else null end)) as filter_dist_cnt_3,count(distinct (case when column_04 > 20 and column_27 IN ('31','27') then  user_id2 else null end)) as filter_dist_cnt_4,count(distinct ( case when column_05 > 90 and column_28 IN ('41','43') then  user_id2 else null end)) as filter_dist_cnt_5 from user_event where ds >= '2023-11-02' group by ds,column_19,column_36", "test_mv1")

select
ds
,column_19 
,column_36
,sum(column_01) as column_01_sum
,bitmap_union_count(to_bitmap( user_id)) as user_id_dist_cnt
,bitmap_union_count(to_bitmap(case when column_01 > 1 and column_34 IN ('1','34')   then user_id2 else null end)) as filter_dist_cnt_1
,bitmap_union_count(to_bitmap( case when column_02 > 60 and column_35 IN ('11','13') then  user_id2 else null end)) as filter_dist_cnt_2
,bitmap_union_count(to_bitmap(case when column_03 > 70 and column_36 IN ('21','23') then  user_id2 else null end)) as filter_dist_cnt_3
,bitmap_union_count(to_bitmap(case when column_04 > 20 and column_27 IN ('31','27') then  user_id2 else null end)) as filter_dist_cnt_4
,bitmap_union_count(to_bitmap( case when column_05 > 90 and column_28 IN ('41','43') then  user_id2 else null end)) as filter_dist_cnt_5
 from user_event
 where ds >= '2023-11-02'
 group by
 ds
 ,column_19
 ,column_36
 order by 
 ds
 ,column_19
 ,column_36;

select
ds
,column_19 
,column_36
,sum(column_01) as column_01_sum
 ,count(distinct  user_id) as user_id_dist_cnt
 ,count(distinct (case when column_01 > 1 and column_34 IN ('1','34')   then user_id2 else null end)) as filter_dist_cnt_1
 ,count(distinct ( case when column_02 > 60 and column_35 IN ('11','13') then  user_id2 else null end)) as filter_dist_cnt_2
 ,count(distinct (case when column_03 > 70 and column_36 IN ('21','23') then  user_id2 else null end)) as filter_dist_cnt_3
 ,count(distinct (case when column_04 > 20 and column_27 IN ('31','27') then  user_id2 else null end)) as filter_dist_cnt_4
 ,count(distinct ( case when column_05 > 90 and column_28 IN ('41','43') then  user_id2 else null end)) as filter_dist_cnt_5
 from user_event
 where ds >= '2023-11-02'
 group by
 ds
 ,column_19
 ,column_36
  order by 
 ds
 ,column_19
 ,column_36;

 select
 column_19 
,column_36
 ,sum(column_01) as column_01_sum
 ,count(distinct user_id) as user_id_dist_cnt
,count(distinct (case when column_01 > 1 and column_34 IN ('1','34')  then user_id2 else null end)) as filter_dist_cnt_1
,count(distinct (case when column_02 > 60 and column_35 IN ('11','13') then  user_id2 else null end)) as filter_dist_cnt_2
 from user_event
 where ds in ('2023-11-02')
 group by
 ds
 ,column_19
 ,column_36
  order by 
 ds
 ,column_19
 ,column_36;

INSERT INTO user_event (ds, id, user_id, user_id1, user_id2, column_01, column_02, column_03, column_04, column_05, column_06, column_07, column_08, column_09, column_10, column_11, column_12, column_13, column_14, column_15, column_16, column_17, column_18, column_19, column_20, column_21, column_22, column_23, column_24, column_25, column_26, column_27, column_28, column_29, column_30, column_31, column_32, column_33, column_34, column_35, column_36, column_37, column_38, column_39, column_40, column_41, column_42, column_43, column_44, column_45, column_46, column_47, column_48, column_49, column_50, column_51, column_52, column_53, column_54, column_55, column_56, column_57, column_58, column_59, column_60, column_61, column_62, column_63, column_64, column_65, column_66, column_67, column_68, column_69, column_70, column_71, column_72, column_73, column_74, column_75, column_76, column_77, column_78, column_79, column_80, column_81, column_82, column_83, column_84, column_85, column_86, column_87, column_88, column_89, column_90, column_91, column_92, column_93, column_94, column_95, column_96, column_97, column_98)
VALUES
('2023-11-02', '1', 1, '2', '1', 10, 20, 30, 40, 50, 12.34, 56.789, '{"key":""}', '2023-11-02 12:34:56', '2023-11-02 12:34:56', '2023-11-02', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98'),
('2023-11-01', '1', 1, '2', '1', 10, 20, 30, 40, 50, 12.34, 56.789, '{"key":""}', '2023-11-02 12:34:56', '2023-11-02 12:34:56', '2023-11-02', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98');
function: check_no_hit_materialized_view("select ds,column_19 ,column_36,sum(column_01) as column_01_sum,count(distinct  user_id) as user_id_dist_cnt,count(distinct (case when column_01 > 1 and column_34 IN ('1','34')   then user_id2 else null end)) as filter_dist_cnt_1,count(distinct ( case when column_02 > 60 and column_35 IN ('11','13') then  user_id2 else null end)) as filter_dist_cnt_2,count(distinct (case when column_03 > 70 and column_36 IN ('21','23') then  user_id2 else null end)) as filter_dist_cnt_3,count(distinct (case when column_04 > 20 and column_27 IN ('31','27') then  user_id2 else null end)) as filter_dist_cnt_4,count(distinct ( case when column_05 > 90 and column_28 IN ('41','43') then  user_id2 else null end)) as filter_dist_cnt_5 from user_event group by ds,column_19,column_36", "test_mv1")
function: check_hit_materialized_view("select ds,column_19 ,column_36,sum(column_01) as column_01_sum,count(distinct  user_id) as user_id_dist_cnt,count(distinct (case when column_01 > 1 and column_34 IN ('1','34')   then user_id2 else null end)) as filter_dist_cnt_1,count(distinct ( case when column_02 > 60 and column_35 IN ('11','13') then  user_id2 else null end)) as filter_dist_cnt_2,count(distinct (case when column_03 > 70 and column_36 IN ('21','23') then  user_id2 else null end)) as filter_dist_cnt_3,count(distinct (case when column_04 > 20 and column_27 IN ('31','27') then  user_id2 else null end)) as filter_dist_cnt_4,count(distinct ( case when column_05 > 90 and column_28 IN ('41','43') then  user_id2 else null end)) as filter_dist_cnt_5 from user_event where ds >= '2023-11-02' group by ds,column_19,column_36", "test_mv1")


select
ds
,column_19 
,column_36
,sum(column_01) as column_01_sum
,bitmap_union_count(to_bitmap( user_id)) as user_id_dist_cnt
,bitmap_union_count(to_bitmap(case when column_01 > 1 and column_34 IN ('1','34')   then user_id2 else null end)) as filter_dist_cnt_1
,bitmap_union_count(to_bitmap( case when column_02 > 60 and column_35 IN ('11','13') then  user_id2 else null end)) as filter_dist_cnt_2
,bitmap_union_count(to_bitmap(case when column_03 > 70 and column_36 IN ('21','23') then  user_id2 else null end)) as filter_dist_cnt_3
,bitmap_union_count(to_bitmap(case when column_04 > 20 and column_27 IN ('31','27') then  user_id2 else null end)) as filter_dist_cnt_4
,bitmap_union_count(to_bitmap( case when column_05 > 90 and column_28 IN ('41','43') then  user_id2 else null end)) as filter_dist_cnt_5
 from user_event
 where ds >= '2023-11-02'
 group by
 ds
 ,column_19
 ,column_36
 order by 
 ds
 ,column_19
 ,column_36;

select
ds
,column_19 
,column_36
,sum(column_01) as column_01_sum
 ,count(distinct  user_id) as user_id_dist_cnt
 ,count(distinct (case when column_01 > 1 and column_34 IN ('1','34')   then user_id2 else null end)) as filter_dist_cnt_1
 ,count(distinct ( case when column_02 > 60 and column_35 IN ('11','13') then  user_id2 else null end)) as filter_dist_cnt_2
 ,count(distinct (case when column_03 > 70 and column_36 IN ('21','23') then  user_id2 else null end)) as filter_dist_cnt_3
 ,count(distinct (case when column_04 > 20 and column_27 IN ('31','27') then  user_id2 else null end)) as filter_dist_cnt_4
 ,count(distinct ( case when column_05 > 90 and column_28 IN ('41','43') then  user_id2 else null end)) as filter_dist_cnt_5
 from user_event
 where ds >= '2023-11-02'
 group by
 ds
 ,column_19
 ,column_36
  order by 
 ds
 ,column_19
 ,column_36;

 select
 column_19 
,column_36
 ,sum(column_01) as column_01_sum
 ,count(distinct user_id) as user_id_dist_cnt
,count(distinct (case when column_01 > 1 and column_34 IN ('1','34')  then user_id2 else null end)) as filter_dist_cnt_1
,count(distinct (case when column_02 > 60 and column_35 IN ('11','13') then  user_id2 else null end)) as filter_dist_cnt_2
 from user_event
 where ds in ('2023-11-02')
 group by
 ds
 ,column_19
 ,column_36
  order by 
 ds
 ,column_19
 ,column_36;

 drop materialized view test_mv1;