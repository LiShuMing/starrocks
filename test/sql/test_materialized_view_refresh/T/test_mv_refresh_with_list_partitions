-- name: test_mv_refresh_with_list_partitions

CREATE TABLE t1 (
      id BIGINT,
      province VARCHAR(64) not null,
      age SMALLINT,
      dt VARCHAR(10)
)
PRIMARY KEY(id, province)
PARTITION BY LIST (province) (
     PARTITION p1 VALUES IN ("beijing", "chongqing") ,
     PARTITION p2 VALUES IN ("guangdong") 
)
DISTRIBUTED BY HASH(id) BUCKETS 10
PROPERTIES (
    "replication_num" = "1"
);
INSERT INTO t1 VALUES (1, 'beijing', 20, '2024-05-15'), (2, 'chongqing', 20, '2024-05-15'), (3, 'guangdong', 20, '2024-05-15');

CREATE TABLE t2 (
      id BIGINT,
      province VARCHAR(64) not null,
      age SMALLINT,
      dt VARCHAR(10)
)
PRIMARY KEY(id, province)
PARTITION BY LIST (province) (
     PARTITION p1 VALUES IN ("chongqing"),
     PARTITION p2 VALUES IN ("guangdong"),
     PARTITION p3 VALUES IN ("beijing")
)
DISTRIBUTED BY HASH(id) BUCKETS 10
PROPERTIES (
    "replication_num" = "1"
);
INSERT INTO t2 VALUES (1, 'beijing', 20, '2024-05-15'), (2, 'chongqing', 20, '2024-05-15'), (3, 'guangdong', 20, '2024-05-15');

create materialized view test_mv1
partition by province 
distributed by hash(dt, province) buckets 10 
PROPERTIES (
"replication_num" = "1"
) 
as select dt, province, avg(age) from t1 group by dt, province;
select * from test_mv1;
drop materialized view test_mv1;

create materialized view test_mv1
partition by province 
distributed by hash(dt, province) buckets 10 
PROPERTIES (
"replication_num" = "1"
) 
as select dt, province, avg(age) from t2 group by dt, province;
select * from test_mv1;
drop materialized view test_mv1;

drop table t1;